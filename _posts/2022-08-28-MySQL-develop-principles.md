## MySQL 开发的 36 条规范

### 核心原则

#### 1. 尽量不在数据库做运算

SQL 不要使用 md5(), Order by Rand() 等这类运算函数，将复杂运算转移到程序端 CPU。

#### 2. 控制单表数据量

单表数据量过大后会影响数据查询效率，严重情况下会导致整个库都卡住。一般情况下，按照一年内单表数据量预估：单表中纯 INT 不超过 10M 条元组，含 Char 不超过 5M 条元组。

同时，要尽量做好合理的分表，使单表数据量不超载，常见的分表策略有：

- 通过 UserId 的 id 区间进行分表，常用于用户量大、用户特征明显的场景，例如：金融行业等；
- 通过 Date 字段的天、周、月分表，常用于时间计算频繁场景，例如：用户上网记录表、用户短信表、话费表等；
- 通过区域的省、市、区分表；
- 其他策略；

分区表的适用场景主要有：

1. 表非常大，无法全部存在内存，或者只在表的最后有热点数据，其他都是历史数据；
2. 分区表的数据更易维护，可以对独立的分区进行独立的操作；
3. 分区表的数据可以分布在不同的机器上，从而高效使用资源；
4. 可以使用分区表来避免某些特殊的瓶颈；
5. 可以备份和恢复独立的分区；

使用分区表时，需要注意一些相关的限制条件：

1. 一个表最多只能有 1024 个分区；
2. 5.1 版本中，分区表表达式必须时整数，5.5 以上版本可以使用列分区；
3. 分区字段中如果有主键和唯一索引列，那么主键列和唯一列都必须包含进来；
4. 分区表中无法使用外键约束；
5. 需要对现有表的结构进行修改；
6. 所有分区都必须使用相同的存储引擎；
7. 分区函数中可以使用的函数和表达式会有一些限制，todo：啥限制；
8. 某些存储引擎不支持分区，todo 啥引擎；
9. 对于 MyISAM 的分区表，不能使用 load index into cache；
10. 对于 MyISAM 的分区表，使用分区表时需要打开更多的文件描述符。

#### 3. 尽量控制表字段数量

单表的字段数量应该根据业务场景进行优化调整，使单表的字段数少而精，这样有以下好处：

1. IO 高效；
2. 全表遍历；
3. 表修复快；
4. 提高并发；
5. alter table 更快；

按照单表 1G 体积，500W 行数据量进行评估：

- 看顺序读 1G 文件所需的时间不超过 N 秒；
- 单行不超过 200 Byte，
- 不超过 50 个纯 int 字段；
- 不超过 20 个 char(10) 字段；

**建议单表字段数上限控制在 20-50个**。

#### 4. 平衡范式与冗余

数据库表结构的设计要遵守三大范式：

1. 第一范式（确保每列保持原子性）：单个字段不可再分；
2. 第二范式（确保表中每列都和主键相关）：不存在非主属性，只依赖部分主键，消除不完全依赖；
3. 第三范式（确保每列都和主键直接相关）：消除传递依赖。

范式是以性能换取存储，冗余是以存储换取性能。因此，一般情况下工作中冗余更受欢迎。

模型设计时，这两方面的权衡首先应以企业提供的计算能力和存储资源为基础。其次，二者的权衡需要符合任务需要，因为一般互联网行业中都根据 Kimball 模式实施数据仓库，建模也是以任务驱动的。

#### 5. 拒绝 3B

- Big SQL；
- Big Transaction；
- Big Batch；

在做数据库开发的时候要注意高并发下的瓶颈，防止因高并发造成 数据库瘫痪 。

### 字段类原则

#### 1. 用好数值字段类型

MySQL 的三类数值类型有：

- 整型：TINYINT(1Byte)、TINYINT(1Byte)、SMALLINT(2B)、MEDIUMINT(3B)、INT(4B)、BIGINT(8B)
- 浮点型：FLOAT(4B)、DOUBLE(8B)
- 十进制数字：DECIMAL（M, D）

**INT(1) 和 INT(11)**：1 与 11 是显示长度的区别，无论 INT(x) 的 x 是什么值，存储长度都是 4 Bytes。

**BIGINT AUTO_INCREMENT**: 有符号 int 最大可以支持到约 22 亿，远远大于我们的需求和 MySQL 单表所能支持的性能上限。OLTP（On-Line Transaction Processing）应用中，单表规模一般保持在千万级别，不会达到 22 亿上限。如果加大预留量，可以把主键改为无符号整型，上限为 42 亿，预留量就会更加充足。

使用 bigint 会占用更大的磁盘和内存空间，无效占用会导致更多的数据换如换出，额外增加了 IO 的压力。因此，推荐主键使用 int unsigned 类型，不建议使用 bigint。

**DECIMAL(N, 0)**: 如果采用 DECIMAL 类型，一般小数位不会默认是 0；如果要设置小数位数为0，建议直接使用整型。

#### 2. 将字符转化为数字

